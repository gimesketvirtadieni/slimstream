# SYNOPSIS:
#
#   make [all]       - compiles SlimStreamer
#   make clean       - removes all files generated by make except executable
#   make cleaneast   - removes all files generated by make including executable
#   make tests       - compiles unit tests

VERSION              := $(shell git describe --dirty --always --tags)
ARCH                 := $(shell uname -m)

BASE_DIRECTORY       ?= ..
SOURCES              := $(BASE_DIRECTORY)/src
HEADERS              := -I$(SOURCES)
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/conwrap2/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/cxxopts/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/g3log/src
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/g3log/build/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/networking-ts-impl/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/scope_guard/include/boost
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/type_safe/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/type_safe/external/debug_assert
HEADERS_GTEST        += $(HEADERS)
HEADERS_GTEST        += -I$(BASE_DIRECTORY)/dependencies/googletest/googlemock/include
HEADERS_GTEST        += -I$(BASE_DIRECTORY)/dependencies/googletest/googletest/include
SYMBOLS              += -DVERSION='"$(VERSION)"'
SYMBOLS              += -DSCOPE_GUARD_STANDALONE
EXECUTABLE           ?= SlimStreamer

CXX                  ?= g++
CXX_OPTIONS          += -std=c++1z -c -O3 -g0 -fmessage-length=0 -pthread -Wall -Wnon-virtual-dtor -Woverloaded-virtual

# adding extra option for ARM platforms to get rid of GCC notes about ABI changes
ifneq (,$(findstring arm,$(ARCH)))
CXX_OPTIONS          += -Wno-psabi
endif
CXX_FLAGS            += $(SYMBOLS) $(HEADERS) $(CXX_OPTIONS)
CXX_FLAGS_GTEST      += $(SYMBOLS) $(HEADERS_GTEST) $(CXX_OPTIONS)

LD_DIRECTORIES       += -L$(BASE_DIRECTORY)/dependencies/g3log/build
LD_DIRECTORIES_GTEST += $(LD_DIRECTORIES)
LD_DIRECTORIES_GTEST += -L$(BASE_DIRECTORY)/dependencies/googletest/build/googlemock/lib
LD_DIRECTORIES_GTEST += -L$(BASE_DIRECTORY)/dependencies/googletest/build/googletest/lib
LD_LIBRARIES         += -lasound -latomic -lFLAC -lFLAC++ -lg3logger -pthread -lrt
LD_LIBRARIES_GTEST   += $(LD_LIBRARIES)
LD_LIBRARIES_GTEST   += -lgmock -lgtest
LD_OPTIONS           += -s -static-libgcc -static-libstdc++
LD_FLAGS             += $(LD_DIRECTORIES) $(LD_LIBRARIES) $(LD_OPTIONS)
LD_FLAGS_GTEST       += $(LD_DIRECTORIES_GTEST) $(LD_LIBRARIES_GTEST) $(LD_OPTIONS)

# Default target executed when no arguments are given to make
default_target: link

clean :
	rm -f *.o

cleanest : clean
	rm $(EXECUTABLE)

link : ConsoleSink.o SinkFilter.o SlimStreamer.o Source.o
	$(CXX) -o $(EXECUTABLE) ./ConsoleSink.o ./SinkFilter.o ./SlimStreamer.o ./Source.o $(LD_FLAGS)

ConsoleSink.o :
	$(CXX) -o ./ConsoleSink.o $(SOURCES)/slim/log/ConsoleSink.cpp $(CXX_FLAGS)

SinkFilter.o :
	$(CXX) -o ./SinkFilter.o $(SOURCES)/slim/log/SinkFilter.cpp $(CXX_FLAGS)

SlimStreamer.o :
	$(CXX) -o ./SlimStreamer.o $(SOURCES)/SlimStreamer.cpp $(CXX_FLAGS)

Source.o :
	$(CXX) -o ./Source.o $(SOURCES)/slim/alsa/Source.cpp $(CXX_FLAGS)

RingBufferTest.o :
	$(CXX) -o RingBufferTest.o $(BASE_DIRECTORY)/test/slim/util/buffer/RingBufferTest.cpp $(CXX_FLAGS_GTEST)

tests : tests_link

tests_link : tests_main RingBufferTest.o ConsoleSink.o SinkFilter.o
	$(CXX) -o $(EXECUTABLE) main.o RingBufferTest.o ConsoleSink.o SinkFilter.o $(LD_FLAGS_GTEST)

tests_main :
	$(CXX) -o main.o $(BASE_DIRECTORY)/test/main.cpp $(CXX_FLAGS_GTEST)
