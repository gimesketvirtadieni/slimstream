# SYNOPSIS:
#
#   make [all]       - compiles SlimStreamer
#   make clean       - removes all files generated by make except executable
#   make cleaneast   - removes all files generated by make including executable

VERSION              := $(shell git describe --dirty --always --tags)
ARCH                 := $(shell uname -m)

BASE_DIRECTORY       ?= ..
SOURCES              := $(BASE_DIRECTORY)/src
HEADERS              := -I$(SOURCES)
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/conwrap2/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/cxxopts/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/g3log/src
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/g3log/build/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/networking-ts-impl/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/scope_guard/include/boost
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/type_safe/include
HEADERS              += -I$(BASE_DIRECTORY)/dependencies/type_safe/external/debug_assert
SYMBOLS              += -DVERSION='"$(VERSION)"'
SYMBOLS              += -DSCOPE_GUARD_STANDALONE
EXECUTABLE           ?= SlimStreamer

CXX                  ?= g++
CXX_OPTIONS          += -std=c++1z -c -O3 -g0 -fmessage-length=0 -pthread -Wall -Wnon-virtual-dtor -Woverloaded-virtual

# adding extra option for ARM platforms to get rid of GCC notes about ABI changes
ifneq (,$(findstring arm,$(ARCH)))
CXX_OPTIONS          += -Wno-psabi
endif
CXX_FLAGS            += $(SYMBOLS) $(HEADERS) $(CXX_OPTIONS)

LD_DIRECTORIES       += -L$(BASE_DIRECTORY)/dependencies/g3log/build
LD_LIBRARIES         += -lasound -latomic -lFLAC -lFLAC++ -lg3logger -lpthread -lrt
LD_OPTIONS           += -s -static-libgcc -static-libstdc++
LD_FLAGS             += $(LD_DIRECTORIES) $(LD_LIBRARIES) $(LD_OPTIONS)

# Default target executed when no arguments are given to make
default_target: link

clean :
	rm -f *.o

cleanest : clean
	rm $(EXECUTABLE)

link : ConsoleSink.o SinkFilter.o SlimStreamer.o Source.o
	$(CXX) -o $(EXECUTABLE) ./ConsoleSink.o ./SinkFilter.o ./SlimStreamer.o ./Source.o $(LD_FLAGS)

ConsoleSink.o :
	$(CXX) -o ./ConsoleSink.o $(SOURCES)/slim/log/ConsoleSink.cpp $(CXX_FLAGS)

SinkFilter.o :
	$(CXX) -o ./SinkFilter.o $(SOURCES)/slim/log/SinkFilter.cpp $(CXX_FLAGS)

SlimStreamer.o :
	$(CXX) -o ./SlimStreamer.o $(SOURCES)/SlimStreamer.cpp $(CXX_FLAGS)

Source.o :
	$(CXX) -o ./Source.o $(SOURCES)/slim/alsa/Source.cpp $(CXX_FLAGS)
